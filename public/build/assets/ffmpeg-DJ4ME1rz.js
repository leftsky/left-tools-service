var B=Object.defineProperty;var C=o=>{throw TypeError(o)};var V=(o,e,t)=>e in o?B(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var m=(o,e,t)=>V(o,typeof e!="symbol"?e+"":e,t),U=(o,e,t)=>e.has(o)||C("Cannot "+t);var n=(o,e,t)=>(U(o,e,"read from private field"),t?t.call(o):e.get(o)),R=(o,e,t)=>e.has(o)?C("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(o):e.set(o,t),I=(o,e,t,a)=>(U(o,e,"write to private field"),a?a.call(o,t):e.set(o,t),t);var s;(function(o){o.LOAD="LOAD",o.EXEC="EXEC",o.FFPROBE="FFPROBE",o.WRITE_FILE="WRITE_FILE",o.READ_FILE="READ_FILE",o.DELETE_FILE="DELETE_FILE",o.RENAME="RENAME",o.CREATE_DIR="CREATE_DIR",o.LIST_DIR="LIST_DIR",o.DELETE_DIR="DELETE_DIR",o.ERROR="ERROR",o.DOWNLOAD="DOWNLOAD",o.PROGRESS="PROGRESS",o.LOG="LOG",o.MOUNT="MOUNT",o.UNMOUNT="UNMOUNT"})(s||(s={}));const W=(()=>{let o=0;return()=>o++})(),G=new Error("ffmpeg is not loaded, call `await ffmpeg.load()` first"),P=new Error("called FFmpeg.terminate()");var E,F,v,O,g,A,p;class X{constructor(){R(this,E,null);R(this,F,{});R(this,v,{});R(this,O,[]);R(this,g,[]);m(this,"loaded",!1);R(this,A,()=>{n(this,E)&&(n(this,E).onmessage=({data:{id:e,type:t,data:a}})=>{switch(t){case s.LOAD:this.loaded=!0,n(this,F)[e](a);break;case s.MOUNT:case s.UNMOUNT:case s.EXEC:case s.FFPROBE:case s.WRITE_FILE:case s.READ_FILE:case s.DELETE_FILE:case s.RENAME:case s.CREATE_DIR:case s.LIST_DIR:case s.DELETE_DIR:n(this,F)[e](a);break;case s.LOG:n(this,O).forEach(i=>i(a));break;case s.PROGRESS:n(this,g).forEach(i=>i(a));break;case s.ERROR:n(this,v)[e](a);break}delete n(this,F)[e],delete n(this,v)[e]})});R(this,p,({type:e,data:t},a=[],i)=>n(this,E)?new Promise((l,r)=>{const f=W();n(this,E)&&n(this,E).postMessage({id:f,type:e,data:t},a),n(this,F)[f]=l,n(this,v)[f]=r,i==null||i.addEventListener("abort",()=>{r(new DOMException(`Message # ${f} was aborted`,"AbortError"))},{once:!0})}):Promise.reject(G));m(this,"load",({classWorkerURL:e,...t}={},{signal:a}={})=>(n(this,E)||(I(this,E,e?new Worker(new URL(e,import.meta.url),{type:"module"}):new Worker(new URL("/build/assets/worker-BAOIWoxA.js",import.meta.url),{type:"module"})),n(this,A).call(this)),n(this,p).call(this,{type:s.LOAD,data:t},void 0,a)));m(this,"exec",(e,t=-1,{signal:a}={})=>n(this,p).call(this,{type:s.EXEC,data:{args:e,timeout:t}},void 0,a));m(this,"ffprobe",(e,t=-1,{signal:a}={})=>n(this,p).call(this,{type:s.FFPROBE,data:{args:e,timeout:t}},void 0,a));m(this,"terminate",()=>{const e=Object.keys(n(this,v));for(const t of e)n(this,v)[t](P),delete n(this,v)[t],delete n(this,F)[t];n(this,E)&&(n(this,E).terminate(),I(this,E,null),this.loaded=!1)});m(this,"writeFile",(e,t,{signal:a}={})=>{const i=[];return t instanceof Uint8Array&&i.push(t.buffer),n(this,p).call(this,{type:s.WRITE_FILE,data:{path:e,data:t}},i,a)});m(this,"mount",(e,t,a)=>{const i=[];return n(this,p).call(this,{type:s.MOUNT,data:{fsType:e,options:t,mountPoint:a}},i)});m(this,"unmount",e=>{const t=[];return n(this,p).call(this,{type:s.UNMOUNT,data:{mountPoint:e}},t)});m(this,"readFile",(e,t="binary",{signal:a}={})=>n(this,p).call(this,{type:s.READ_FILE,data:{path:e,encoding:t}},void 0,a));m(this,"deleteFile",(e,{signal:t}={})=>n(this,p).call(this,{type:s.DELETE_FILE,data:{path:e}},void 0,t));m(this,"rename",(e,t,{signal:a}={})=>n(this,p).call(this,{type:s.RENAME,data:{oldPath:e,newPath:t}},void 0,a));m(this,"createDir",(e,{signal:t}={})=>n(this,p).call(this,{type:s.CREATE_DIR,data:{path:e}},void 0,t));m(this,"listDir",(e,{signal:t}={})=>n(this,p).call(this,{type:s.LIST_DIR,data:{path:e}},void 0,t));m(this,"deleteDir",(e,{signal:t}={})=>n(this,p).call(this,{type:s.DELETE_DIR,data:{path:e}},void 0,t))}on(e,t){e==="log"?n(this,O).push(t):e==="progress"&&n(this,g).push(t)}off(e,t){e==="log"?I(this,O,n(this,O).filter(a=>a!==t)):e==="progress"&&I(this,g,n(this,g).filter(a=>a!==t))}}E=new WeakMap,F=new WeakMap,v=new WeakMap,O=new WeakMap,g=new WeakMap,A=new WeakMap,p=new WeakMap;var $;(function(o){o.MEMFS="MEMFS",o.NODEFS="NODEFS",o.NODERAWFS="NODERAWFS",o.IDBFS="IDBFS",o.WORKERFS="WORKERFS",o.PROXYFS="PROXYFS"})($||($={}));const z=new Error("failed to get response body reader"),j=new Error("failed to complete download"),H="Content-Length",K=o=>new Promise((e,t)=>{const a=new FileReader;a.onload=()=>{const{result:i}=a;i instanceof ArrayBuffer?e(new Uint8Array(i)):e(new Uint8Array)},a.onerror=i=>{var l,r;t(Error(`File could not be read! Code=${((r=(l=i==null?void 0:i.target)==null?void 0:l.error)==null?void 0:r.code)||-1}`))},a.readAsArrayBuffer(o)}),N=async o=>{let e;if(typeof o=="string")/data:_data\/([a-zA-Z]*);base64,([^"]*)/.test(o)?e=atob(o.split(",")[1]).split("").map(t=>t.charCodeAt(0)):e=await(await fetch(o)).arrayBuffer();else if(o instanceof URL)e=await(await fetch(o)).arrayBuffer();else if(o instanceof File||o instanceof Blob)e=await K(o);else return new Uint8Array;return new Uint8Array(e)},Y=async(o,e)=>{var i;const t=await fetch(o);let a;try{const l=parseInt(t.headers.get(H)||"-1"),r=(i=t.body)==null?void 0:i.getReader();if(!r)throw z;const f=[];let d=0;for(;;){const{done:h,value:b}=await r.read(),w=b?b.length:0;if(h){if(l!=-1&&l!==d)throw j;e&&e({url:o,total:l,received:d,delta:w,done:h});break}f.push(b),d+=w,e&&e({url:o,total:l,received:d,delta:w,done:h})}const c=new Uint8Array(d);let u=0;for(const h of f)c.set(h,u),u+=h.length;a=c.buffer}catch(l){console.log("failed to send download progress event: ",l),a=await t.arrayBuffer()}return a},S=async(o,e,t=!1,a)=>{const i=t?await Y(o,a):await(await fetch(o)).arrayBuffer(),l=new Blob([i],{type:e});return URL.createObjectURL(l)},y="https://cdn.jsdelivr.net/npm/@ffmpeg/core-mt@0.12.10/dist/esm",Q=[{value:"mp4",label:"MP4 (H.264/H.265)"},{value:"avi",label:"AVI (Xvid)"},{value:"mov",label:"MOV (QuickTime)"},{value:"mkv",label:"MKV (Matroska)"},{value:"wmv",label:"WMV (Windows Media)"},{value:"flv",label:"FLV (Flash Video)"},{value:"webm",label:"WebM (VP8/VP9/AV1)"},{value:"m4v",label:"M4V (iTunes)"},{value:"3gp",label:"3GP (Mobile)"},{value:"ogv",label:"OGV (Ogg Video)"},{value:"ts",label:"TS (Transport Stream)"},{value:"mts",label:"MTS (AVCHD)"},{value:"asf",label:"ASF (Advanced Systems)"},{value:"vob",label:"VOB (DVD Video)"},{value:"mpg",label:"MPG (MPEG-1/2)"},{value:"mpeg",label:"MPEG (MPEG-1/2)"},{value:"divx",label:"DIVX (DivX)"},{value:"xvid",label:"XVID (Xvid)"},{value:"swf",label:"SWF (Flash)"},{value:"f4v",label:"F4V (Flash Video)"},{value:"m2ts",label:"M2TS (Blu-ray)"},{value:"mxf",label:"MXF (Material Exchange)"},{value:"gif",label:"GIF (Animated)"},{value:"apng",label:"APNG (Animated PNG)"},{value:"webp",label:"WebP (Web Picture)"},{value:"avif",label:"AVIF (AV1 Image)"},{value:"heic",label:"HEIC (HEIF)"},{value:"heif",label:"HEIF (High Efficiency)"}],Z=[{value:"high",label:"高质量"},{value:"medium",label:"中等质量"},{value:"low",label:"低质量"}],q=[{value:"original",label:"保持原分辨率"},{value:"4k",label:"4K (3840x2160)"},{value:"1080p",label:"1080p (1920x1080)"},{value:"720p",label:"720p (1280x720)"},{value:"480p",label:"480p (854x480)"}],J=[{value:"original",label:"保持原帧率"},{value:"60",label:"60 FPS"},{value:"30",label:"30 FPS"},{value:"25",label:"25 FPS"},{value:"24",label:"24 FPS"}],ee={"4k":"3840:2160","1080p":"1920:1080","720p":"1280:720","480p":"854:480"},te={high:18,medium:23,low:28},ae=["video/mp4","video/avi","video/quicktime","video/x-matroska","video/x-ms-wmv","video/x-flv","video/webm","video/x-msvideo","video/3gpp","video/ogg","video/mpeg","video/x-m4v"],ie=["mp4","avi","mov","mkv","wmv","flv","webm","m4v","3gp","ogv","ts","mts","rm","rmvb","asf","vob","mpg","mpeg","divx","xvid","swf","f4v","m2ts","mxf","gif","apng","webp","avif","heic","heif"],M=100*1024*1024;class oe{constructor(){this.ffmpeg=new X,this.isLoaded=!1,this.isLoading=!1}async init(e){try{return this.isLoading=!0,e&&e("正在加载资源..."),await this.ffmpeg.load({coreURL:await S(`${y}/ffmpeg-core.js`,"text/javascript"),wasmURL:await S(`${y}/ffmpeg-core.wasm`,"application/wasm"),workerURL:await S(`${y}/ffmpeg-core.worker.js`,"text/javascript")}),this.isLoaded=!0,this.isLoading=!1,e&&e("资源加载完成！"),!0}catch(t){throw console.error("FFmpeg加载失败:",t),this.isLoading=!1,new Error("资源加载失败，请刷新页面重试")}}getSupportedConfigs(){return{outputFormats:Q,videoQualityOptions:Z,resolutionOptions:q,framerateOptions:J,supportedFileTypes:ae,supportedExtensions:ie,maxFileSize:M}}async convert(e,t,a){if(!this.isLoaded)throw new Error("FFmpeg尚未初始化，请先调用init()方法");let i,l,r;if(typeof e=="string")try{a&&a("正在获取在线文件...",0);const d=await fetch(e);if(!d.ok)throw new Error(`无法获取文件: ${d.statusText}`);const c=await d.blob();i=new File([c],"input_video",{type:c.type}),l=this.getFileExtensionFromUrl(e)||"mp4",r=`input_video.${l}`,a&&a("在线文件获取完成",5)}catch(d){throw new Error(`获取在线文件失败: ${d instanceof Error?d.message:"未知错误"}`)}else i=e,l=this.getFileExtension(e.name),r=e.name;if(i.size>M)throw new Error("文件过大，请选择小于100MB的文件");const f=t.outputFormat||"mp4";console.log("开始转换:",r,"→",f);try{a&&a("正在写入输入文件...",5),await this.ffmpeg.writeFile(`input.${l}`,await N(i)),a&&a("输入文件写入完成，开始转码...",10),await this.performSeparateTranscode(l,f,t,a),a&&a("正在读取输出文件...",90);const d=await this.ffmpeg.readFile(`output.${f}`);if(!d||d.length===0)throw new Error("输出文件为空或无效");const c=d,u=c.buffer.slice(c.byteOffset,c.byteOffset+c.byteLength),h=new Blob([u],{type:`video/${f}`});a&&a("转换完成！",100),await this.cleanupFiles(l,f);const w=`${r.substring(0,r.lastIndexOf("."))}.${f}`;return{blob:h,filename:w,size:c.length}}catch(d){throw console.error("转换失败:",d),await this.cleanupFiles(l,f),d}}getFileExtension(e){var t;return((t=e.split(".").pop())==null?void 0:t.toLowerCase())||"mp4"}getFileExtensionFromUrl(e){try{const a=new URL(e).pathname;return this.getFileExtension(a)}catch{return"mp4"}}async performSeparateTranscode(e,t,a,i){let l=0,r=0,f=0;const d=new Promise((c,u)=>{setTimeout(()=>{u(new Error("转换超时，请尝试更小的文件或更低的设置"))},1e3*60)});try{if(this.ffmpeg.off("log"),i){const D=({message:_})=>{if(_.includes("frame=")){const T=_.match(/frame=\s*(\d+)/);if(T){const x=parseInt(T[1]),k=Math.min(10+x/1e3*30,40);i(`正在转码视频... (帧: ${x})`,parseFloat(k.toFixed(2)))}}};this.ffmpeg.on("log",D)}i&&i("开始转码视频...",10);const c=this.buildVideoCommand(e,t,a),u=Date.now();await Promise.race([this.ffmpeg.exec(c),d]),l=Date.now()-u,i&&i("视频转码完成，开始处理音频...",40);const h=this.buildAudioCommand(e,t),b=Date.now();await Promise.race([this.ffmpeg.exec(h),d]),r=Date.now()-b,i&&i("音频处理完成，开始合并...",70);const w=this.buildMergeCommand(t),L=Date.now();await Promise.race([this.ffmpeg.exec(w),d]),f=Date.now()-L,i&&i("合并完成",90),console.log("转码完成，总耗时:",l+r+f,"ms"),i&&this.ffmpeg.off("log")}catch(c){throw console.error("转码失败:",c),i&&this.ffmpeg.off("log"),c}}buildVideoCommand(e,t,a){const i=["-i",`input.${e}`];if(a.resolution&&a.resolution!=="original"){const r=ee[a.resolution];r&&i.push("-vf",`scale=${r}`)}a.framerate&&a.framerate!=="original"&&i.push("-r",a.framerate);const l=te[a.videoQuality||"medium"]||23;return i.push("-c:v","libx264","-preset","ultrafast","-crf",l.toString()),i.push("-an"),i.push("-y",`video_only.${t}`),i}buildAudioCommand(e,t){const a=["-i",`input.${e}`];return a.push("-vn"),t==="avi"?(a.push("-c:a","mp3","-b:a","128k","-ar","44100"),a.push("-y","audio.mp3")):(a.push("-c:a","aac","-b:a","128k","-ar","48000"),a.push("-y","audio.aac")),a}buildMergeCommand(e){const t=e==="avi"?"audio.mp3":"audio.aac";return["-i",`video_only.${e}`,"-i",t,"-c:v","copy","-c:a","copy","-shortest","-y",`output.${e}`]}async cleanupFiles(e,t){try{let a=[`input.${e}`];if(t){const i=t==="avi"?"audio.mp3":"audio.aac";a=[`input.${e}`,`video_only.${t}`,i,`output.${t}`]}for(const i of a)try{await this.ffmpeg.deleteFile(i)}catch(l){console.warn("删除临时文件失败:",l)}}catch(a){console.warn("清理临时文件失败:",a)}}isReady(){return this.isLoaded&&!this.isLoading}getLoadingState(){return{isLoaded:this.isLoaded,isLoading:this.isLoading}}async getFileInfo(e,t){if(!this.isLoaded)throw new Error("FFmpeg尚未初始化，请先调用init()方法");let a,i,l;if(typeof e=="string")try{t&&t("正在获取在线文件信息...");const r=await fetch(e);if(!r.ok)throw new Error(`无法获取文件: ${r.statusText}`);const f=await r.blob();a=new File([f],"input_video",{type:f.type}),i=this.getFileExtensionFromUrl(e)||"mp4",l=`input_video.${i}`,t&&t("在线文件获取完成")}catch(r){throw new Error(`获取在线文件失败: ${r instanceof Error?r.message:"未知错误"}`)}else a=e,i=this.getFileExtension(e.name),l=e.name;if(a.size>M)throw new Error("文件过大，请选择小于100MB的文件");try{t&&t("正在分析文件信息..."),await this.ffmpeg.writeFile(`input.${i}`,await N(a));let r={duration:null,resolution:null,fps:null,videoCodec:null,audioCodec:null,bitrate:null};const f=({message:c})=>{if(c.includes("Duration:")){const u=c.match(/Duration: (\d{2}):(\d{2}):(\d{2}\.\d{2})/);if(u){const h=parseInt(u[1]),b=parseInt(u[2]),w=parseFloat(u[3]);r.duration=h*3600+b*60+w}}if(c.includes("Video:")){const u=c.match(/(\d{3,4})x(\d{3,4})/),h=c.match(/(\d+) fps/),b=c.match(/Video: (\w+)/),w=c.match(/(\d+) kb\/s/);if(u){const L=parseInt(u[1]),D=parseInt(u[2]);L>=100&&D>=100&&(r.resolution=`${L}x${D}`)}h&&(r.fps=parseInt(h[1])),b&&(r.videoCodec=b[1]),w&&(r.bitrate=`${w[1]} kb/s`)}if(c.includes("Audio:")){const u=c.match(/Audio: (\w+)/);u&&(r.audioCodec=u[1])}};this.ffmpeg.on("log",f);try{await this.ffmpeg.exec(["-i",`input.${i}`])}finally{this.ffmpeg.off("log",f)}await this.cleanupFiles(i,null);const d={filename:l,size:a.size,sizeFormatted:this.formatFileSize(a.size),duration:r.duration,durationFormatted:r.duration?this.formatDuration(r.duration):null,format:i,bitrate:r.bitrate?r.bitrate.replace(" kb/s",""):null,bitrateFormatted:r.bitrate,video:r.resolution?{codec:r.videoCodec||"未知",width:r.resolution?parseInt(r.resolution.split("x")[0]):null,height:r.resolution?parseInt(r.resolution.split("x")[1]):null,resolution:r.resolution,framerate:r.fps,bitrate:r.bitrate?r.bitrate.replace(" kb/s",""):null,bitrateFormatted:r.bitrate}:null,audio:r.audioCodec?{codec:r.audioCodec,channels:null,sampleRate:null,bitrate:null,bitrateFormatted:null}:null,streams:(r.resolution?1:0)+(r.audioCodec?1:0)};return t&&t("文件信息分析完成"),d}catch(r){throw console.error("获取文件信息失败:",r),await this.cleanupFiles(i,null),new Error(`获取文件信息失败: ${r instanceof Error?r.message:"未知错误"}`)}}formatFileSize(e){if(e===0)return"0 B";const t=1024,a=["B","KB","MB","GB"],i=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,i)).toFixed(2))+" "+a[i]}formatDuration(e){const t=Math.floor(e/3600),a=Math.floor(e%3600/60),i=Math.floor(e%60);return t>0?`${t}:${a.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`:`${a}:${i.toString().padStart(2,"0")}`}formatBitrate(e){if(e===0)return"0 bps";const t=1e3,a=["bps","Kbps","Mbps","Gbps"],i=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,i)).toFixed(2))+" "+a[i]}parseFrameRate(e){if(!e)return null;const t=e.split("/");if(t.length===2){const a=parseInt(t[0]),i=parseInt(t[1]);return i!==0?(a/i).toFixed(2):null}return parseFloat(e).toFixed(2)}}const ne=new oe;export{J as F,Q as O,q as R,Z as V,ne as f};
